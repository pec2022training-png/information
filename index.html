<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸è¯çµ¡äººå›é¥‹ç®¡ç†ç³»çµ± - è‡ªæ’é †åºç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1450px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 15px; margin: 0 0 20px 0; }
        
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .inline-input { width: 100%; padding: 6px; border: 1px solid #1a73e8; border-radius: 4px; box-sizing: border-box; font-size: 0.85rem; margin-bottom: 2px; }
        .inline-input:disabled { background-color: #f5f5f5; border: 1px solid #ddd; color: #888; }
        
        .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; font-weight: 500; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-success { background: #34a853; color: white; }
        .btn-danger { background: #ea4335; color: white; }
        .btn-secondary { background: #70757a; color: white; }
        .btn-sort { background: #f8f9fa; color: #333; border: 1px solid #ddd; margin-right: 2px; }
        .btn-sort:hover { background: #e8f0fe; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th, td { border: 1px solid #f1f3f4; padding: 10px; text-align: left; vertical-align: middle; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; color: #555; }
        
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: white; font-weight: bold; white-space: nowrap; display: inline-block; }
        .tag-yes { background: #34a853; }
        .tag-no { background: #dadce0; color: #5f6368; }
        tr.editing-row { background-color: #e8f0fe; }

        .status-col { min-width: 180px; }
        .move-btns { display: flex; flex-direction: column; gap: 2px; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="!isLoggedIn && !isAdmin" class="login-overlay">
        <div class="login-box">
            <h3 style="margin-top:0;">ğŸ¢ è¯çµ¡äººè³‡è¨Šç¶­è­·ç³»çµ±</h3>
            <div style="margin-bottom: 15px;">
                <label>è«‹è¼¸å…¥å…¬å¸çµ±ä¸€ç·¨è™Ÿ (8ç¢¼)ï¼š</label>
                <input type="text" v-model="loginTaxId" maxlength="8" @input="autoSearchCompany" class="inline-input" style="font-size: 1rem;">
            </div>
            <div v-if="/^\d{8}$/.test(loginTaxId)">
                <div style="margin-bottom: 10px;"><label>å…¬å¸åç¨±ï¼š</label><input type="text" v-model="editorInfo.company" class="inline-input"></div>
                <div style="margin-bottom: 10px;"><label>å§“åï¼š</label><input type="text" v-model="editorInfo.name" class="inline-input"></div>
                <div style="margin-bottom: 15px;"><label>åˆ†æ©Ÿï¼š</label><input type="text" v-model="editorInfo.ext" class="inline-input"></div>
                <button class="btn btn-primary" style="width: 100%;" @click="login">ç¢ºèªé€²å…¥</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <div>
                <h2>{{ isAdmin ? 'ğŸ’ ç³»çµ±ç®¡ç†å“¡å¾Œå°' : 'ğŸ“ è²´å…¬å¸è¯çµ¡è³‡è¨Šå›é¥‹' }}</h2>
                <p v-if="!isAdmin" style="color: #666; margin:0;">
                    ç›®å‰ä½œæ¥­çµ±ç·¨ï¼š<strong>{{ currentTaxId }}</strong> | å…¬å¸ï¼š<strong>{{ editorInfo.company }}</strong><br>
                    <small>ğŸ’¡ é»æ“Šã€Œâ†‘ã€æˆ–ã€Œâ†“ã€å¯èª¿æ•´æ’åºï¼ŒåŒ¯å‡ºæ™‚å°‡ä¾æ­¤é †åºç”¢ç”Ÿã€‚</small>
                </p>
                <p v-else style="color: #666; margin:0;">
                    <small>ğŸ’¡ ç®¡ç†å“¡æ¨¡å¼ï¼šå¯é€²è¡ŒåŒ¯å…¥ã€åŒ¯å‡ºèˆ‡æ‰¹æ¬¡åˆªé™¤å‹¾é¸é …ç›®ã€‚</small>
                </p>
            </div>
            <div style="display:flex; gap:8px; flex-wrap: wrap; justify-content: flex-end;">
                <template v-if="isAdmin">
                    <button v-if="selectedIds.length > 0" class="btn btn-danger" @click="batchDelete">ğŸ—‘ï¸ æ‰¹æ¬¡åˆªé™¤ ({{ selectedIds.length }})</button>
                    <button class="btn btn-secondary" @click="triggerImport">ğŸ“¥ åŒ¯å…¥ Excel</button>
                    <input type="file" ref="fileInput" style="display:none" accept=".xlsx, .xls, .csv" @change="handleImport">
                    <button class="btn btn-success" @click="exportExcel">ğŸ“Š åŒ¯å‡º Excel</button>
                    <button class="btn btn-danger" @click="clearAllData" style="opacity: 0.7;">ğŸ—‘ï¸ æ¸…ç©ºå…¨åº«</button>
                </template>
                <button v-if="!editingId && !isAdding" class="btn btn-primary" @click="startAddNew">â• æ–°å¢è¯çµ¡äºº</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th v-if="isAdmin" style="width: 40px; text-align: center;">
                        <input type="checkbox" @change="toggleSelectAll" :checked="isAllSelected">
                    </th>
                    <th style="width: 100px;">çµ±ç·¨</th>
                    <th style="min-width: 180px;">å…¬å¸/å–®ä½</th>
                    <th style="width: 120px;">å§“å/è·ç¨±</th>
                    <th style="min-width: 200px;">è¯ç¹«æ–¹å¼</th>
                    <th class="status-col">ç‹€æ…‹ç¢ºèª</th>
                    <th style="width: 100px;">æœ€å¾Œç•°å‹•</th>
                    <th style="width: 140px;">æ“ä½œ/æ’åº</th>
                </tr>
            </thead>
            <tbody>
                <tr v-if="isAdding" class="editing-row">
                    <td v-if="isAdmin"></td>
                    <td><input type="text" v-model="editForm.taxId" class="inline-input" :disabled="!isAdmin"></td>
                    <td>
                        <input type="text" v-model="editForm.compName" class="inline-input" :disabled="!isAdmin">
                        <input type="text" v-model="editForm.dept" class="inline-input" placeholder="å–®ä½">
                    </td>
                    <td>
                        <input type="text" v-model="editForm.name" class="inline-input" placeholder="å§“å">
                        <input type="text" v-model="editForm.title" class="inline-input" placeholder="è·ç¨±">
                    </td>
                    <td>
                        <input type="text" v-model="editForm.phone" class="inline-input" placeholder="é›»è©±">
                        <input type="email" v-model="editForm.email" class="inline-input" placeholder="Email">
                        <input type="text" v-model="editForm.address" class="inline-input" placeholder="åœ°å€">
                    </td>
                    <td>
                        <select v-model="editForm.isTrainer" class="inline-input">
                            <option value="YES">è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦:YES</option>
                            <option value="NO">è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦:NO</option>
                        </select>
                        <select v-model="editForm.sendDM" class="inline-input" style="margin-top:4px;">
                            <option value="YES">æ¯å­£å¯„ç™¼DM:YES</option>
                            <option value="NO">æ¯å­£å¯„ç™¼DM:NO</option>
                        </select>
                    </td>
                    <td>-</td>
                    <td>
                        <button class="btn btn-success" @click="saveData" style="width:100%; margin-bottom:2px;">å„²å­˜</button>
                        <button class="btn btn-secondary" @click="cancelEdit" style="width:100%;">å–æ¶ˆ</button>
                    </td>
                </tr>

                <tr v-for="(item, index) in filteredData" :key="item.id" :class="{'editing-row': editingId === item.id}">
                    <td v-if="isAdmin" style="text-align: center;">
                        <input type="checkbox" v-model="selectedIds" :value="item.id">
                    </td>
                    <td>
                        <input v-if="editingId === item.id" v-model="editForm.taxId" class="inline-input" :disabled="!isAdmin">
                        <span v-else><strong>{{ item.taxId }}</strong></span>
                    </td>
                    <td>
                        <div v-if="editingId === item.id">
                            <input v-model="editForm.compName" class="inline-input" :disabled="!isAdmin">
                            <input v-model="editForm.dept" class="inline-input" placeholder="å–®ä½">
                        </div>
                        <div v-else>{{ item.compName }}<br><small style="color:#888">{{ item.dept }}</small></div>
                    </td>
                    <td>
                        <div v-if="editingId === item.id">
                            <input v-model="editForm.name" class="inline-input" placeholder="å§“å">
                            <input v-model="editForm.title" class="inline-input" placeholder="è·ç¨±">
                        </div>
                        <div v-else>{{ item.name }}<br><small style="color:#888">{{ item.title }}</small></div>
                    </td>
                    <td>
                        <div v-if="editingId === item.id">
                            <input v-model="editForm.phone" class="inline-input" placeholder="é›»è©±">
                            <input v-model="editForm.email" class="inline-input" placeholder="Email">
                            <input v-model="editForm.address" class="inline-input" placeholder="åœ°å€">
                        </div>
                        <div v-else>ğŸ“ {{ item.phone }}<br>âœ‰ï¸ {{ item.email }}<br><small>ğŸ“ {{ item.address }}</small></div>
                    </td>
                    <td>
                        <div v-if="editingId === item.id">
                            <select v-model="editForm.isTrainer" class="inline-input">
                                <option value="YES">è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦:YES</option>
                                <option value="NO">è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦:NO</option>
                            </select>
                            <select v-model="editForm.sendDM" class="inline-input" style="margin-top:4px;">
                                <option value="YES">æ¯å­£å¯„ç™¼DM:YES</option>
                                <option value="NO">æ¯å­£å¯„ç™¼DM:NO</option>
                            </select>
                        </div>
                        <div v-else>
                            <span :class="['tag', item.isTrainer === 'YES' ? 'tag-yes' : 'tag-no']">è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦:{{ item.isTrainer }}</span><br>
                            <span :class="['tag', item.sendDM === 'YES' ? 'tag-yes' : 'tag-no']" style="margin-top:5px;">æ¯å­£å¯„ç™¼DM:{{ item.sendDM }}</span>
                        </div>
                    </td>
                    <td style="font-size: 0.7rem; color: #666;">{{ item.lastEditor }}<br>{{ formatDate(item.updateTime) }}</td>
                    <td>
                        <div v-if="editingId === item.id">
                            <button class="btn btn-success" @click="saveData" style="width:100%; margin-bottom:2px;">å„²å­˜</button>
                            <button class="btn btn-secondary" @click="cancelEdit" style="width:100%;">å–æ¶ˆ</button>
                        </div>
                        <div v-else style="display: flex; gap: 5px; align-items: center;">
                            <div class="move-btns">
                                <button class="btn btn-sort" @click="moveItem(index, -1)" title="ä¸Šç§»">â†‘</button>
                                <button class="btn btn-sort" @click="moveItem(index, 1)" title="ä¸‹ç§»">â†“</button>
                            </div>
                            <div style="flex:1">
                                <button class="btn btn-primary" @click="startEdit(item)" style="width:100%; padding:2px; margin-bottom:2px;">æ”¹</button>
                                <button class="btn btn-danger" @click="deleteItem(item.id)" style="width:100%; padding:2px;">åˆª</button>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
const { createApp } = Vue;
const firebaseConfig = {
    apiKey: "AIzaSyA97EbUfh620b-Bz2eFeSifptEOBkL_v7U",
    authDomain: "training-76bd2.firebaseapp.com",
    databaseURL: "https://training-76bd2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "training-76bd2",
    storageBucket: "training-76bd2.firebasestorage.app",
    messagingSenderId: "1032641306025",
    appId: "1:1032641306025:web:a25f74c2bef92268dcf8b8",
    measurementId: "G-EQ84DXPD97"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

createApp({
    data() {
        return {
            isAdmin: false, isLoggedIn: false, loginTaxId: '', currentTaxId: '',
            editorInfo: { company: '', name: '', ext: '' },
            allData: [], editingId: null, isAdding: false, editForm: {},
            selectedIds: [],
            fieldMap: {
                'çµ±ä¸€ç·¨è™Ÿ': 'taxId', 'å…¬å¸åç¨±': 'compName', 'å–®ä½': 'dept', 'å§“å': 'name', 'è·ç¨±': 'title',
                'é›»è©±': 'phone', 'åˆ†æ©Ÿ': 'ext', 'FAX': 'fax', 'e-mail': 'email', 'åœ°å€': 'address',
                'è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦(YES/NO)': 'isTrainer', 'æ¯å­£å¯„ç™¼DM(YES/NO)': 'sendDM'
            }
        }
    },
    computed: {
        filteredData() {
            let data = this.isAdmin ? this.allData : this.allData.filter(d => String(d.taxId).trim() === String(this.currentTaxId).trim());
            return data.sort((a, b) => (a.order || 0) - (b.order || 0) || (a.updateTime - b.updateTime));
        },
        isAllSelected() {
            return this.filteredData.length > 0 && this.selectedIds.length === this.filteredData.length;
        }
    },
    mounted() {
        const urlParams = new URLSearchParams(window.location.search);
        this.isAdmin = urlParams.get('role') === 'admin';
        db.ref('company_contacts').on('value', s => {
            const val = s.val();
            this.allData = val ? Object.keys(val).map(k => ({ id: k, ...val[k] })) : [];
        });
    },
    methods: {
        autoSearchCompany() {
            if (this.loginTaxId.length === 8) {
                const found = this.allData.find(d => String(d.taxId).trim() === this.loginTaxId.trim());
                if (found) this.editorInfo.company = found.compName;
            }
        },
        login() { 
            if (!this.editorInfo.company.trim()) return alert("è«‹è¼¸å…¥å…¬å¸åç¨±");
            this.currentTaxId = this.loginTaxId.trim(); 
            this.isLoggedIn = true; 
        },
        toggleSelectAll(e) {
            if (e.target.checked) {
                this.selectedIds = this.filteredData.map(d => d.id);
            } else {
                this.selectedIds = [];
            }
        },
        async batchDelete() {
            if (this.selectedIds.length === 0) return;
            if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${this.selectedIds.length} ç­†é¸ä¸­çš„è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯é‚„åŸã€‚`)) {
                try {
                    const promises = this.selectedIds.map(id => db.ref(`company_contacts/${id}`).remove());
                    await Promise.all(promises);
                    this.selectedIds = []; // æ¸…ç©ºé¸å–é …
                    alert('æ‰¹æ¬¡åˆªé™¤å®Œæˆ');
                } catch (err) {
                    alert('åˆªé™¤éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤');
                    console.error(err);
                }
            }
        },
        async moveItem(index, direction) {
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= this.filteredData.length) return;
            const currentItem = this.filteredData[index];
            const targetItem = this.filteredData[targetIndex];
            let currentOrder = currentItem.order !== undefined ? currentItem.order : index;
            let targetOrder = targetItem.order !== undefined ? targetItem.order : targetIndex;
            if (currentOrder === targetOrder) targetOrder = currentOrder + direction;
            await db.ref(`company_contacts/${currentItem.id}`).update({ order: targetOrder });
            await db.ref(`company_contacts/${targetItem.id}`).update({ order: currentOrder });
        },
        startAddNew() {
            this.isAdding = true; this.editingId = null;
            const maxOrder = this.filteredData.length > 0 ? Math.max(...this.filteredData.map(d => d.order || 0)) : 0;
            this.editForm = { taxId: this.currentTaxId, compName: this.editorInfo.company, dept: '', name: '', title: '', phone: '', ext: '', fax: '', email: '', address: '', isTrainer: 'NO', sendDM: 'NO', order: maxOrder + 1 };
        },
        startEdit(item) { this.editingId = item.id; this.isAdding = false; this.editForm = JSON.parse(JSON.stringify(item)); },
        cancelEdit() { this.editingId = null; this.isAdding = false; this.editForm = {}; },
        saveData() {
            if (!this.editForm.taxId || !this.editForm.compName || !this.editForm.name) return alert("å¿…å¡«æ¬„ä½ç¼ºå¤±");
            const payload = { ...this.editForm, updateTime: Date.now(), lastEditor: this.isAdmin ? 'ç®¡ç†å“¡' : this.editorInfo.name };
            const id = payload.id;
            delete payload.id;
            if (id) db.ref(`company_contacts/${id}`).update(payload);
            else db.ref('company_contacts').push(payload);
            this.cancelEdit();
        },
        deleteItem(id) { 
            if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                db.ref(`company_contacts/${id}`).remove();
                this.selectedIds = this.selectedIds.filter(sid => sid !== id);
            }
        },
        clearAllData() { if (confirm('è­¦å‘Šï¼å³å°‡æ¸…ç©ºæ‰€æœ‰è³‡æ–™åº«å…§å®¹ï¼Œç¢ºå®šï¼Ÿ')) db.ref('company_contacts').remove(); },
        triggerImport() { this.$refs.fileInput.click(); },
        handleImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                json.forEach((row, index) => {
                    const newDoc = {};
                    Object.keys(this.fieldMap).forEach(zh => { 
                        let val = String(row[zh] || '').trim();
                        if (zh.includes('YES/NO')) val = val.toUpperCase().includes('Y') ? 'YES' : 'NO';
                        newDoc[this.fieldMap[zh]] = val; 
                    });
                    newDoc.updateTime = Date.now();
                    newDoc.lastEditor = "ExcelåŒ¯å…¥";
                    newDoc.order = index; 
                    if (newDoc.taxId) db.ref('company_contacts').push(newDoc);
                });
                alert('åŒ¯å…¥å®Œæˆ'); e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        },
        exportExcel() {
            const rows = this.filteredData.map(item => ({
                'çµ±ä¸€ç·¨è™Ÿ': item.taxId, 'å…¬å¸åç¨±': item.compName, 'å–®ä½': item.dept, 'å§“å': item.name, 'è·ç¨±': item.title,
                'é›»è©±': item.phone, 'åˆ†æ©Ÿ': item.ext, 'FAX': item.fax, 'e-mail': item.email, 'åœ°å€': item.address,
                'è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦(YES/NO)': item.isTrainer, 'æ¯å­£å¯„ç™¼DM(YES/NO)': item.sendDM,
                'æœ€å¾Œç•°å‹•': item.lastEditor, 'ç•°å‹•æ™‚é–“': this.formatDate(item.updateTime)
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `è¯çµ¡äººè³‡æ–™åº«_${new Date().toLocaleDateString()}.xlsx`);
        },
        formatDate(ms) { return ms ? new Date(ms).toLocaleString() : '-'; }
    }
}).mount('#app');
</script>
</body>
</html>
