<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸çª—å£å›é¥‹ç®¡ç†ç³»çµ± - é€²éšç®¡ç†ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 15px; margin: 0 0 20px 0; }
        
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        
        .section { margin-bottom: 25px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff; }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .full-width { grid-column: 1 / -1; }
        
        label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 0.9rem; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; transition: 0.2s; font-weight: 500; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-success { background: #34a853; color: white; }
        .btn-danger { background: #ea4335; color: white; }
        .btn-secondary { background: #70757a; color: white; }
        .btn:hover { opacity: 0.9; }

        /* æ‰¹é‡æ“ä½œå·¥å…·åˆ— */
        .batch-bar { background: #fff9c4; padding: 12px; border-radius: 6px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid #fbc02d; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        th, td { border: 1px solid #f1f3f4; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; }
        
        .tag { padding: 3px 6px; border-radius: 4px; font-size: 0.7rem; color: white; font-weight: bold; }
        .tag-yes { background: #34a853; }
        .tag-no { background: #dadce0; color: #5f6368; }
    </style>
</head>
<body>

<div id="app">
    <div v-if="!isLoggedIn && !isAdmin" class="login-overlay">
        <div class="login-box">
            <h3 style="margin-top:0;">ğŸ¢ çª—å£è³‡è¨Šç¶­è­·ç³»çµ±</h3>
            <div style="margin-bottom: 15px;">
                <label>è«‹è¼¸å…¥å…¬å¸çµ±ä¸€ç·¨è™Ÿ (8ç¢¼)ï¼š</label>
                <input type="text" v-model="loginTaxId" maxlength="8" @input="autoSearchCompany">
            </div>
            <div v-if="/^\d{8}$/.test(loginTaxId)">
                <div style="margin-bottom: 10px;"><label>ç·¨ä¿®äººå…¬å¸ï¼š</label><input type="text" v-model="editorInfo.company"></div>
                <div style="margin-bottom: 10px;"><label>ç·¨ä¿®äººå§“åï¼š</label><input type="text" v-model="editorInfo.name"></div>
                <div style="margin-bottom: 15px;"><label>ç·¨ä¿®äººåˆ†æ©Ÿï¼š</label><input type="text" v-model="editorInfo.ext"></div>
                <button class="btn btn-primary" style="width: 100%;" @click="login">ç¢ºèªé€²å…¥</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <div>
                <h2>{{ isAdmin ? 'ğŸ’ ç³»çµ±ç®¡ç†å“¡å¾Œå°' : 'ğŸ“ è²´å…¬å¸è¯çµ¡è³‡è¨Šå›é¥‹' }}</h2>
                <div v-if="!isAdmin" style="color: #666;">çµ±ç·¨ï¼š<strong>{{ currentTaxId }}</strong></div>
            </div>
            <div v-if="isAdmin" style="display:flex; gap:8px;">
                <button class="btn btn-secondary" @click="triggerImport">ğŸ“¥ åŒ¯å…¥ Excel</button>
                <input type="file" ref="fileInput" style="display:none" accept=".xlsx, .xls, .csv" @change="handleImport">
                <button class="btn btn-success" @click="exportExcel">ğŸ“Š åŒ¯å‡º Excel</button>
                <button class="btn btn-danger" @click="clearAllData">ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™åº«</button>
            </div>
        </div>

        <div v-if="isAdmin && selectedIds.length > 0" class="batch-bar">
            <strong>å·²é¸å– {{ selectedIds.length }} ç­†è³‡æ–™</strong>
            <button class="btn btn-danger" @click="deleteBatch">âš ï¸ æ‰¹é‡åˆªé™¤é¸å–é …</button>
            <button class="btn btn-secondary" @click="selectedIds = []">å–æ¶ˆé¸å–</button>
        </div>

        <div v-if="showEditForm" class="section">
            <h3 style="margin-top:0;">{{ editingId ? 'âœï¸ ä¿®æ”¹è³‡è¨Š' : 'â• æ–°å¢çª—å£' }}</h3>
            <div class="grid-form">
                <div><label>çµ±ä¸€ç·¨è™Ÿ</label><input type="text" v-model="form.taxId" :disabled="!isAdmin"></div>
                <div><label>å…¬å¸åç¨±</label><input type="text" v-model="form.compName"></div>
                <div><label>å–®ä½</label><input type="text" v-model="form.dept"></div>
                <div><label>å§“å</label><input type="text" v-model="form.name"></div>
                <div><label>è·ç¨±</label><input type="text" v-model="form.title"></div>
                <div><label>é›»è©±</label><input type="text" v-model="form.phone"></div>
                <div><label>åˆ†æ©Ÿ</label><input type="text" v-model="form.ext"></div>
                <div><label>FAX</label><input type="text" v-model="form.fax"></div>
                <div class="full-width"><label>e-mail</label><input type="email" v-model="form.email"></div>
                <div class="full-width"><label>åœ°å€</label><input type="text" v-model="form.address"></div>
                <div><label>è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦</label><select v-model="form.isTrainer"><option value="YES">YES</option><option value="NO">NO</option></select></div>
                <div><label>å¯„ç™¼DM</label><select v-model="form.sendDM"><option value="YES">YES</option><option value="NO">NO</option></select></div>
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-secondary" @click="showEditForm = false">å–æ¶ˆ</button>
                <button class="btn btn-primary" @click="saveData" style="margin-left: 10px;">å„²å­˜</button>
            </div>
        </div>

        <div v-if="!showEditForm">
            <button class="btn btn-primary" @click="openAddForm" style="margin-bottom: 10px;">â• æ–°å¢çª—å£</button>
            <table>
                <thead>
                    <tr>
                        <th v-if="isAdmin" style="width: 40px;"><input type="checkbox" @change="toggleSelectAll" :checked="isAllSelected"></th>
                        <th v-if="isAdmin">çµ±ç·¨</th>
                        <th>å…¬å¸/å–®ä½</th>
                        <th>å§“å/è·ç¨±</th>
                        <th>è¯ç¹«æ–¹å¼</th>
                        <th>ç‹€æ…‹</th>
                        <th>æœ€å¾Œç•°å‹•</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in filteredData" :key="item.id">
                        <td v-if="isAdmin"><input type="checkbox" v-model="selectedIds" :value="item.id"></td>
                        <td v-if="isAdmin"><strong>{{ item.taxId }}</strong></td>
                        <td>{{ item.compName }}<br><small style="color:#888">{{ item.dept }}</small></td>
                        <td>{{ item.name }}<br><small style="color:#888">{{ item.title }}</small></td>
                        <td>ğŸ“ {{ item.phone }} #{{ item.ext }}<br>âœ‰ï¸ {{ item.email }}</td>
                        <td>
                            <span :class="['tag', item.isTrainer === 'YES' ? 'tag-yes' : 'tag-no']">è¨“:{{ item.isTrainer }}</span><br>
                            <span :class="['tag', item.sendDM === 'YES' ? 'tag-yes' : 'tag-no']" style="display:inline-block; margin-top:5px;">DM:{{ item.sendDM }}</span>
                        </td>
                        <td style="font-size: 0.7rem; color: #666;">{{ item.lastEditor }}<br>{{ formatDate(item.updateTime) }}</td>
                        <td>
                            <button class="btn btn-primary" @click="editItem(item)" style="padding: 4px 8px; font-size: 0.75rem;">æ”¹</button>
                            <button class="btn btn-danger" @click="deleteItem(item.id)" style="padding: 4px 8px; font-size: 0.75rem; margin-top:3px;">åˆª</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const { createApp } = Vue;
const firebaseConfig = {
    apiKey: "AIzaSyA97EbUfh620b-Bz2eFeSifptEOBkL_v7U",
    authDomain: "training-76bd2.firebaseapp.com",
    databaseURL: "https://training-76bd2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "training-76bd2",
    storageBucket: "training-76bd2.firebasestorage.app",
    messagingSenderId: "1032641306025",
    appId: "1:1032641306025:web:a25f74c2bef92268dcf8b8",
    measurementId: "G-EQ84DXPD97"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

createApp({
    data() {
        return {
            isAdmin: false, isLoggedIn: false, loginTaxId: '', currentTaxId: '',
            editorInfo: { company: '', name: '', ext: '' },
            allData: [], showEditForm: false, editingId: null,
            form: this.getEmptyForm(),
            selectedIds: [], // å­˜æ”¾è¢«å‹¾é¸çš„ ID
            fieldMap: {
                'çµ±ä¸€ç·¨è™Ÿ': 'taxId', 'å…¬å¸åç¨±': 'compName', 'å–®ä½': 'dept', 'å§“å': 'name', 'è·ç¨±': 'title',
                'é›»è©±': 'phone', 'åˆ†æ©Ÿ': 'ext', 'FAX': 'fax', 'e-mail': 'email', 'åœ°å€': 'address',
                'è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦(YES/NO)': 'isTrainer', 'æ¯å­£å¯„ç™¼DM(YES/NO)': 'sendDM'
            }
        }
    },
    computed: {
        filteredData() {
            if (this.isAdmin) return this.allData;
            return this.allData.filter(d => String(d.taxId).trim() === String(this.currentTaxId).trim());
        },
        isAllSelected() {
            return this.filteredData.length > 0 && this.selectedIds.length === this.filteredData.length;
        }
    },
    mounted() {
        const urlParams = new URLSearchParams(window.location.search);
        this.isAdmin = urlParams.get('role') === 'admin';
        db.ref('company_contacts').on('value', s => {
            const val = s.val();
            this.allData = val ? Object.keys(val).map(k => ({ id: k, ...val[k] })) : [];
        });
    },
    methods: {
        getEmptyForm() { return { taxId: '', compName: '', dept: '', name: '', title: '', phone: '', ext: '', fax: '', email: '', address: '', isTrainer: 'NO', sendDM: 'NO' }; },
        autoSearchCompany() {
            if (this.loginTaxId.length === 8) {
                const found = this.allData.find(d => String(d.taxId).trim() === this.loginTaxId.trim());
                if (found) this.editorInfo.company = found.compName;
            }
        },
        login() { this.currentTaxId = this.loginTaxId.trim(); this.isLoggedIn = true; },
        openAddForm() {
            this.editingId = null; this.form = this.getEmptyForm(); this.form.taxId = this.currentTaxId;
            const ref = this.allData.find(d => String(d.taxId).trim() === String(this.currentTaxId).trim());
            if (ref) { this.form.compName = ref.compName; this.form.address = ref.address; }
            this.showEditForm = true;
        },
        editItem(item) { this.editingId = item.id; this.form = { ...item }; this.showEditForm = true; },
        saveData() {
            const payload = { ...this.form, taxId: String(this.form.taxId).trim(), updateTime: Date.now(), 
                lastEditor: this.isAdmin ? 'ç®¡ç†å“¡' : `${this.editorInfo.name}` 
            };
            if (this.editingId) db.ref(`company_contacts/${this.editingId}`).update(payload);
            else db.ref('company_contacts').push(payload);
            this.showEditForm = false;
        },
        deleteItem(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) db.ref(`company_contacts/${id}`).remove(); },
        // --- æ‰¹é‡æ“ä½œ ---
        toggleSelectAll() {
            if (this.isAllSelected) this.selectedIds = [];
            else this.selectedIds = this.filteredData.map(d => d.id);
        },
        deleteBatch() {
            if (confirm(`ç¢ºå®šè¦æ‰¹é‡åˆªé™¤é€™ ${this.selectedIds.length} ç­†è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œä¸å¯é‚„åŸï¼`)) {
                this.selectedIds.forEach(id => db.ref(`company_contacts/${id}`).remove());
                this.selectedIds = [];
                alert('åˆªé™¤æˆåŠŸ');
            }
        },
        clearAllData() {
            if (confirm('ã€è­¦å‘Šã€‘æ‚¨å³å°‡æ¸…ç©ºè³‡æ–™åº«ä¸­ã€Œæ‰€æœ‰ã€å…¬å¸çš„çª—å£è³‡æ–™ï¼\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                if (confirm('è«‹å†æ¬¡ç¢ºèªï¼Œæ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰å…§å®¹ã€‚')) {
                    db.ref('company_contacts').remove();
                    alert('è³‡æ–™åº«å·²æ¸…ç©º');
                }
            }
        },
        formatDate(ms) { return ms ? new Date(ms).toLocaleString() : '-'; },
        triggerImport() { this.$refs.fileInput.click(); },
        handleImport(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                const workbook = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                json.forEach(row => {
                    const newDoc = {};
                    Object.keys(this.fieldMap).forEach(zh => { newDoc[this.fieldMap[zh]] = String(row[zh] || '').trim(); });
                    newDoc.updateTime = Date.now(); newDoc.lastEditor = "Excelæ‰¹é‡åŒ¯å…¥";
                    if (newDoc.taxId) db.ref('company_contacts').push(newDoc);
                });
                alert('åŒ¯å…¥å®Œæˆ'); e.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        },
        exportExcel() {
            const rows = this.allData.map(item => ({
                'çµ±ä¸€ç·¨è™Ÿ': item.taxId, 'å…¬å¸åç¨±': item.compName, 'å–®ä½': item.dept, 'å§“å': item.name, 'è·ç¨±': item.title,
                'é›»è©±': item.phone, 'åˆ†æ©Ÿ': item.ext, 'FAX': item.fax, 'e-mail': item.email, 'åœ°å€': item.address,
                'è¨“ç·´ä¸»ç®¡æˆ–ä¸»è¾¦(YES/NO)': item.isTrainer, 'æ¯å­£å¯„ç™¼DM(YES/NO)': item.sendDM,
                'æœ€å¾Œç•°å‹•': item.lastEditor, 'æ™‚é–“': this.formatDate(item.updateTime)
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, "å…¬å¸çª—å£ç¸½è¡¨.xlsx");
        }
    }
}).mount('#app');
</script>
</body>

</html>
